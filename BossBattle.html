<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>部門共鬥遊戲 - Boss Battle</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #e67e22; --dark: #1a1a1a; }
        body { background: var(--dark); color: white; font-family: sans-serif; text-align: center; margin: 0; }
        .hidden { display: none !important; }
        
        /* 大螢幕樣式 */
        #boss-img { width: 200px; margin-top: 50px; transition: 0.2s; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% {transform:translate(2px,2px)} 50% {transform:translate(-2px,-2px)} 100% {transform:translate(0)} }
        #hp-container { width: 80%; background: #333; height: 30px; margin: 20px auto; border-radius: 15px; overflow: hidden; border: 2px solid white; }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff4b2b, #ff416c); transition: 0.5s; }

        /* 玩家按鈕樣式 */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .ans-btn { background: var(--primary); border: none; padding: 30px; color: white; font-size: 24px; border-radius: 10px; cursor: pointer; }
        .ans-btn:active { transform: scale(0.95); background: #d35400; }
        
        /* 管理員樣式 */
        .admin-panel { background: #333; padding: 20px; border-radius: 10px; margin: 20px; }
    </style>
</head>
<body>

<div id="player-view" class="hidden">
    <h2 id="player-status">等待遊戲開始...</h2>
    <div id="answer-zone" class="hidden">
        <div class="btn-grid">
            <button class="ans-btn" onclick="submitAns('A')">A</button>
            <button class="ans-btn" onclick="submitAns('B')">B</button>
            <button class="ans-btn" onclick="submitAns('C')">C</button>
            <button class="ans-btn" onclick="submitAns('D')">D</button>
        </div>
    </div>
</div>

<div id="display-view" class="hidden">
    <h1 id="round-title">準備開戰</h1>
    <img id="boss-img" src="https://cdn-icons-png.flaticon.com/512/1423/1423783.png">
    <div id="hp-container"><div id="hp-bar"></div></div>
    <div id="hp-text">HP: 12000 / 12000</div>
    <div id="live-count" style="font-size: 20px; color: #f1c40f;">已加入人數: 0</div>
    <div id="damage-msg" style="font-size: 30px; margin-top: 20px;"></div>
</div>

<div id="admin-view" class="hidden">
    <h2>管理員控制台</h2>
    <div class="admin-panel">
        <p>當前題號: <span id="admin-q-num">1</span></p>
        <button onclick="changeQ(1, 'A')">開始第 1 題 (答 A)</button>
        <button onclick="changeQ(2, 'B')">開始第 2 題 (答 B)</button>
        <button onclick="calculateResult()">結算本題傷害</button>
        <button onclick="resetGame()" style="background: red; color:white;">重設遊戲</button>
    </div>
</div>

<script>
    // --- 請填入你的 Firebase 配置 ---
    const firebaseConfig = {
        apiKey: "AIzaSyDwwKME2_neH-VxZObTStJ_uRuJI_-C-tw",
        databaseURL: "https://department-boss-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "department-boss-battle",
        appId: "1:112990000902:web:5b003355322134537e3087"
    };
    // ----------------------------

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get('role'); // player, admin, display

    // 初始化角色視圖
    if(role === 'admin') document.getElementById('admin-view').classList.remove('hidden');
    else if(role === 'display') document.getElementById('display-view').classList.remove('hidden');
    else document.getElementById('player-view').classList.remove('hidden');

    // --- 核心邏輯 ---

    // 監聽遊戲狀態
    db.ref('gameState').on('value', (snap) => {
        const state = snap.val() || { q: 0, status: 'waiting', hp: 12000 };
        
        if(role === 'display') {
            document.getElementById('hp-bar').style.width = (state.hp / 12000 * 100) + "%";
            document.getElementById('hp-text').innerText = `HP: ${state.hp} / 12000`;
            document.getElementById('round-title').innerText = state.q > 0 ? `第 ${state.q} 題` : "等待開戰";
            if(state.lastDmg) {
                document.getElementById('damage-msg').innerText = `造成 ${state.lastDmg} 傷害!`;
                document.getElementById('boss-img').classList.add('shake');
                setTimeout(()=>document.getElementById('boss-img').classList.remove('shake'), 500);
            }
        }

        if(role === 'player') {
            const statusText = document.getElementById('player-status');
            const zone = document.getElementById('answer-zone');
            if(state.status === 'answering') {
                statusText.innerText = `第 ${state.q} 題：請選擇答案`;
                zone.classList.remove('hidden');
            } else {
                statusText.innerText = "請看大螢幕...";
                zone.classList.add('hidden');
            }
        }
    });

    // 統計加入人數 (顯示在大螢幕)
    db.ref('responses').on('value', snap => {
        if(role === 'display') {
            const count = snap.numChildren();
            document.getElementById('live-count').innerText = `已投票人數: ${count}`;
        }
    });

    // --- 各端功能函數 ---

    // 玩家：提交答案
    function submitAns(ans) {
        const uid = localStorage.getItem('game_uid') || Math.random().toString(36).substring(7);
        localStorage.setItem('game_uid', uid);
        db.ref('responses/' + uid).set(ans);
        document.getElementById('answer-zone').classList.add('hidden');
        document.getElementById('player-status').innerText = "答案已送出，等待結算...";
    }

    // 管理員：切換題目
    function changeQ(q, ans) {
        db.ref('responses').remove();
        db.ref('gameState').update({ q: q, status: 'answering', correctAns: ans, lastDmg: 0 });
        document.getElementById('admin-q-num').innerText = q;
    }

    // 管理員：結算傷害 (自動計算邏輯)
    function calculateResult() {
        db.ref().once('value', snap => {
            const data = snap.val();
            const resps = Object.values(data.responses || {});
            const correct = resps.filter(a => a === data.gameState.correctAns).length;
            const rate = resps.length > 0 ? (correct / resps.length) * 100 : 0;
            
            let dmg = 0;
            if(rate <= 20) dmg = 100;
            else if(rate <= 40) dmg = 300;
            else if(rate <= 60) dmg = 600;
            else if(rate <= 80) dmg = 1000;
            else dmg = 1500;

            const newHP = Math.max(0, data.gameState.hp - dmg);
            db.ref('gameState').update({ status: 'result', hp: newHP, lastDmg: dmg });
        });
    }

    function resetGame() {
        if(confirm("確定重置遊戲？")) {
            db.ref('/').set({ gameState: { q: 0, status: 'waiting', hp: 12000, lastDmg: 0 } });
        }
    }
</script>
</body>
</html>