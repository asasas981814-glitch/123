<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMDåœ˜çµä¸€å¿ƒ-Bosså¤§æŒ‘æˆ°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f39c12; --danger: #e74c3c; --success: #27ae60; --max-hp: 20000; }
        body { background: #121212; color: white; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* è¦–è¦ºå‘ˆç¾ */
        #display-view { padding: 20px; text-align: center; }
        .hurt-flash { animation: flash-red 0.6s ease; }
        @keyframes flash-red { 0%, 100% { background: none; } 50% { background: rgba(231, 76, 60, 0.4); } }
        
        #boss-container { position: relative; display: inline-block; margin: 40px auto; min-height: 320px; }
        #boss-img { width: 320px; transition: all 0.3s; filter: drop-shadow(0 0 20px rgba(255,255,255,0.1)); }
        
        /* Boss èªªè©±æ°£æ³¡ */
        #boss-bubble {
            position: absolute; top: -10px; right: -180px; background: white; color: black; 
            padding: 15px 25px; border-radius: 20px; font-weight: bold; font-size: 22px;
            max-width: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 3px solid #333;
            z-index: 100; display: none; text-align: left; animation: bubble-pop 0.3s forwards;
        }
        #boss-bubble::after { content: ''; position: absolute; left: -20px; top: 30px; border: 10px solid transparent; border-right-color: white; }
        @keyframes bubble-pop { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* è¡€æ¢æ¨£å¼ */
        #hp-wrapper { width: 85%; background: #222; height: 45px; border: 4px solid #fff; margin: 20px auto; border-radius: 25px; overflow: hidden; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff416c, #ff4b2b); transition: width 0.8s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        
        /* é£„å­—å‚·å®³ */
        #dmg-text { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 90px; font-weight: 900; color: #ff3e3e; opacity: 0; pointer-events: none; z-index: 200; text-shadow: 3px 3px 0 #000, 0 0 20px #fff; }
        .dmg-float { animation: dmg-anim 1.2s forwards; }
        @keyframes dmg-anim { 0% { opacity: 1; transform: translate(-50%, 0) scale(0.8); } 50% { transform: translate(-50%, -80px) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -150px) scale(1); } }

        /* å¡ç‰‡è¨­è¨ˆ */
        .q-card { background: rgba(0,0,0,0.85); padding: 30px; border-radius: 20px; border: 3px solid var(--primary); margin: 20px auto; max-width: 900px; box-shadow: 0 0 30px rgba(243, 156, 18, 0.3); }
        .stat-bar-bg { background: #333; height: 28px; border-radius: 14px; margin: 10px 0; overflow: hidden; border: 1px solid #555; }
        .stat-bar-fill { height: 100%; background: #666; width: 0%; transition: width 1s ease-out; }
        .correct-fill { background: var(--success) !important; box-shadow: 0 0 15px var(--success); }

        /* å¥³ç¥ç¥ç¦ */
        #blessing-banner {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #f1c40f, #f39c12); color: #fff;
            padding: 40px; border-radius: 30px; font-size: 36px; font-weight: bold;
            text-align: center; z-index: 3000; display: none; border: 8px solid white;
            box-shadow: 0 0 100px gold; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); width: 80%;
        }

        .player-btn { background: linear-gradient(145deg, #f39c12, #e67e22); color: white; border: none; padding: 20px; font-size: 24px; border-radius: 15px; width: 100%; cursor: pointer; font-weight: bold; box-shadow: 0 5px #d35400; }
        .player-btn:active { transform: translateY(3px); box-shadow: 0 2px #d35400; }
    </style>
</head>
<body>

<audio id="game-bgm" src="BGM.mp3" loop></audio>
<div id="blessing-banner">
    å•Ÿå‹•å¹¸é‹å¥³ç¥çš„ç¥ç¦ï¼<br>
    <span style="font-size: 24px;">å¹´çµ‚çé‡‘ç¿»å€ï¼Œå°¾ç‰™ä¸­çæ©Ÿç‡æé«˜</span><br>
    <span style="font-size: 28px;">æ‰€æœ‰æˆ°å£«å—åˆ°é¼“èˆï¼Œçµ¦äºˆæ€ªç‰© 5000 é»å‚·å®³ï¼</span>
</div>

<div id="name-overlay" class="hidden">
    <div style="text-align: center; padding: 100px 20px;">
        <h2 style="font-size: 40px; color: var(--primary);">ğŸ›¡ï¸ æˆ°å£«åŠ å…¥æˆ°å ´ ğŸ›¡ï¸</h2>
        <input type="text" id="player-name-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—" style="padding:20px; font-size:24px; border-radius:15px; width: 80%; max-width: 400px; border: 2px solid var(--primary); background: #222; color: white; text-align: center;"><br><br>
        <button class="player-btn" style="width:250px" onclick="saveName()">åŠ å…¥æˆ°é¬¥</button>
    </div>
</div>

<div id="display-view" class="hidden">
    <div style="display:flex; justify-content: space-around; align-items: center; padding: 10px 50px;">
        <h1 id="round-num" style="font-size: 50px; color: var(--primary);">READY?</h1>
        <h1 id="d-timer" style="font-size: 60px; color: var(--danger);"></h1>
    </div>

    <div id="boss-container">
        <div id="boss-bubble"></div>
        <div id="dmg-text"></div>
        <img id="boss-img" src="Boss_normal.png">
    </div>

    <div id="hp-wrapper">
        <div id="hp-bar"></div>
        <div style="position: absolute; width:100%; top:0; line-height:45px; font-weight:900; font-size: 26px; text-shadow: 1px 1px 2px #000;">HP: <span id="hp-text">20000</span> / 20000</div>
    </div>

    <div id="stat-area" class="q-card hidden">
        <h2 style="margin-top:0; font-size: 36px; color: var(--primary);">æˆ°åŠ›çµç®—</h2>
        <div id="stat-bars"></div>
        <h3 id="stat-rate" style="font-size: 32px; margin-bottom: 0;"></h3>
    </div>

    <div id="mvp-announcement" class="q-card hidden">
        <h2 style="color: gold; font-size: 45px;">ğŸ† æˆ°å ´è‹±é›„æ¦œ ğŸ†</h2>
        <div id="mvp-list" style="font-size: 28px;"></div>
    </div>

    <div id="display-q-box" class="q-card hidden">
        <h2 id="d-title" style="font-size: 42px; margin-top: 0;"></h2>
        <div id="d-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 30px; text-align: left;"></div>
    </div>
</div>

<div id="player-view" class="hidden">
    <div id="player-waiting" style="text-align: center; margin-top: 150px;">
        <h2 id="wait-msg" style="font-size: 36px;">ç­‰å¾…æŒ‡æ®å®˜ç™¼å¸ƒä»»å‹™...</h2>
    </div>
    <div id="player-q-zone" class="hidden" style="padding: 20px;">
        <div id="p-q-timer" style="font-size: 40px; color: var(--danger); text-align: center; font-weight: bold;">â³ 10s</div>
        <h3 id="p-title" style="font-size: 32px; text-align: center;"></h3>
        <div id="p-options"></div>
    </div>
</div>

<div id="admin-view" class="hidden" style="padding: 20px; text-align: center;">
    <div id="admin-btns" style="background:#222; padding:20px; border-radius:20px;"></div>
    <div style="display:flex; gap:20px; margin-top:20px;">
        <button onclick="calculateResult()" style="flex:2; background:var(--success); color:white; padding:30px; font-size:30px; border-radius:15px; border:none; font-weight:bold; cursor:pointer;">ğŸ’¥ ç™¼å‹•æ”»æ“Š (çµç®—)</button>
        <button onclick="triggerBlessing()" style="flex:1; background:gold; padding:30px; font-size:24px; border-radius:15px; border:none; font-weight:bold; cursor:pointer;">âœ¨ å¥³ç¥ç¥ç¦</button>
    </div>
    <br>
    <button onclick="resetGame()" style="background:#c0392b; color:white; padding:15px 30px; border-radius:10px; border:none; cursor:pointer;">ğŸ’£ é‡ç½®éŠæˆ²</button>
</div>

<script>
    const BOSS_MAX_HP = 20000;
    const BASE_DAMAGE = 2500;
    const trashTalks = ["é€™é»æ”»æ“Šåƒåœ¨åˆ®ç—§ï¼", "å“è³ªå°ˆæ¥­å‘¢ï¼Ÿæˆ‘çš„è¡€æ¢é‚„å¤šå¾—å¾ˆï¼", "æ‰“å…¶ä»–åœ°æ–¹å¯ä»¥ï¼Œæ‰“è‡‰ä¸è¡Œï¼", "ç„¡çŸ¥çš„äººé¡ï¼Œæº–å‚™æ‰¿å—æ€’ç«ï¼"];
    
    const firebaseConfig = {
        apiKey: "AIzaSyDwwKME2_neH-VxZObTStJ_uRuJI_-C-tw",
        authDomain: "department-boss-battle.firebaseapp.com",
        databaseURL: "https://department-boss-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "department-boss-battle",
        storageBucket: "department-boss-battle.firebasestorage.app",
        messagingSenderId: "112990000902",
        appId: "1:112990000902:web:5b003355322134537e3087"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const params = new URLSearchParams(window.location.search);
    const role = params.get('role') || 'player';
    const uid = localStorage.getItem('game_uid') || Math.random().toString(36).substring(7);
    localStorage.setItem('game_uid', uid);

    const questionBank = {
        1: { t: "è«‹å•ä»Šå¤©çš„ä¸»æŒäººå¸¥å—?", o: {A:"å¸¥", B:"å¾ˆå¸¥", C:"è¶…å¸¥", D:"ç‰¹åˆ¥å¸¥"}, a: "ALL" },
        2: { t: "Moxaåœ¨å“ªè£¡?", o: {A:"æ¿æ©‹", B:"æ–°èŠ", C:"ä¸­å’Œ", D:"æ°¸å’Œ"}, a: "B" },
        3: { t: "æˆ‘å€‘æ˜¯ç”šéº¼è‚¡ä»½æœ‰é™å…¬å¸?", o: {A:"101", B:"202", C:"303", D:"404"}, a: "D" },
        4: { t: "CEå…¨ç¨±?", o: {A:"Common Era", B:"Civil Engineer", C:"Component Engineer", D:"Computer Engineer"}, a: "C" },
        5: { t: "ä»Šå¹´å¼·èª¿çš„ä¸»é¡Œæ˜¯?", o: {A:"å”ä½œ", B:"å”åŠ›è»Š", C:"å­«å”å¿—", D:"å”å”å”"}, a: "A" },
        6: { t: "CAæœ€æ‰›çš„ç”·äººæ˜¯èª°?", o: {A:"Boozer", B:"Booger", C:"Booder", D:"Booker"}, a: "A" },
        7: { t: "CEå¤©æ‰ç•«æ‰‹æ˜¯èª°?", o: {A:"Daneil", B:"Dennis", C:"Demmis", D:"Deccis"}, a: "B" },
        8: { t: "CAè¬ è¨€è£½é€ è€…æ˜¯èª°?", o: {A:"Naoh", B:"Nhao", C:"Noah", D:"Noha"}, a: "C" },
        9: { t: "CAä¹‹æ¯æ˜¯èª°?", o: {A:"Lica", B:"Lisa", C:"Liya", D:"Liwa"}, a: "B" },
        10: { t: "CAå°çŒ´æ˜¯èª°?", o: {A:"Tiffiya", B:"Tiffant", C:"Tiffjia", D:"Tiffany"}, a: "D" }
    };

    db.ref('resetTrigger').on('value', snap => {
        if (snap.val() === true) {
            localStorage.removeItem('boss_player_name');
            location.reload();
        }
    });

    function saveName() {
        const name = document.getElementById('player-name-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥æˆ°å£«åï¼");
        localStorage.setItem('boss_player_name', name);
        db.ref('players/' + uid).set(name);
        document.getElementById('name-overlay').classList.add('hidden');
        document.getElementById('player-view').classList.remove('hidden');
    }

    if(role === 'player') {
        if(!localStorage.getItem('boss_player_name')) document.getElementById('name-overlay').classList.remove('hidden');
        else {
            document.getElementById('player-view').classList.remove('hidden');
            db.ref('players/' + uid).set(localStorage.getItem('boss_player_name'));
        }
    } else if(role === 'display') {
        document.getElementById('display-view').classList.remove('hidden');
    } else if(role === 'admin') {
        document.getElementById('admin-view').classList.remove('hidden');
        const container = document.getElementById('admin-btns');
        for(let i=1; i<=10; i++) container.innerHTML += `<button onclick="changeQ(${i})" style="margin:5px; padding:15px; width:80px; font-size:18px;">ä»»å‹™ ${i}</button>`;
    }

    let currentResId = "";

    db.ref('gameState').on('value', snap => {
        const state = snap.val() || { hp: BOSS_MAX_HP, status: 'waiting' };
        
        if(role === 'display') {
            document.getElementById('hp-bar').style.width = (state.hp/BOSS_MAX_HP*100) + "%";
            document.getElementById('hp-text').innerText = state.hp;
            
            if(state.status === 'answering') {
                document.getElementById('display-q-box').classList.remove('hidden');
                document.getElementById('stat-area').classList.add('hidden');
                document.getElementById('mvp-announcement').classList.add('hidden');
                document.getElementById('boss-bubble').style.display = 'none';
                document.getElementById('d-timer').innerText = `â³ ${state.timeLeft}s`;
                const q = questionBank[state.q];
                document.getElementById('d-title').innerText = q.t;
                document.getElementById('d-options').innerHTML = Object.entries(q.o).map(([k,v])=>`<div>${k}. ${v}</div>`).join('');
                document.getElementById('round-num').innerText = `ç¬¬ ${state.q} é¡Œ`;
            } 
            else if(state.status === 'result' && state.resId !== currentResId) {
                currentResId = state.resId;
                showResultEffect(state);
            }

            if(state.hp <= 0) {
                document.getElementById('boss-img').style.transform = "scale(0) rotate(720deg)";
                findMVP();
            }

            const banner = document.getElementById('blessing-banner');
            if(state.showBlessing) { 
                banner.style.display = 'block'; 
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#FFD700', '#FFFFFF'] });
                setTimeout(()=>banner.style.display='none', 3500); 
            }
        } 
        else if(role === 'player') {
            updatePlayerView(state);
        }
    });

    function showResultEffect(state) {
        document.getElementById('display-q-box').classList.add('hidden');
        document.getElementById('stat-area').classList.remove('hidden');
        
        const qData = questionBank[state.q] || {a:''};
        const dist = state.distribution || {A:0, B:0, C:0, D:0};
        const total = Math.max(1, Object.values(dist).reduce((a,b)=>a+b, 0));
        
        document.getElementById('stat-bars').innerHTML = ['A','B','C','D'].map(k => {
            const per = (dist[k]/total*100);
            const isCorrect = (qData.a === 'ALL' || qData.a === k);
            return `<div style="text-align:left; font-size:24px; margin-top:10px;">${k}: ${dist[k]} äºº</div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill ${isCorrect?'correct-fill':''}" style="width:${per}%"></div></div>`;
        }).join('');
        
        document.getElementById('stat-rate').innerHTML = `ç­”å°ç‡: <span style="color:var(--success)">${state.correctRate}%</span> | é€ æˆçš„å‚·å®³: <span style="color:var(--danger)">${state.lastDmg}</span>`;

        // å—å‚·å‹•ç•«èˆ‡èªªè©±
        if(state.lastDmg > 0) {
            const bubble = document.getElementById('boss-bubble');
            bubble.innerText = state.customTalk || trashTalks[Math.floor(Math.random()*trashTalks.length)];
            bubble.style.display = 'block';

            const dmgText = document.getElementById('dmg-text');
            dmgText.innerText = `-${state.lastDmg}`;
            dmgText.classList.add('dmg-float');
            document.getElementById('display-view').classList.add('hurt-flash');
            document.getElementById('boss-img').style.transform = "translateX(-30px) rotate(10deg) scale(0.9)";
            
            setTimeout(() => {
                dmgText.classList.remove('dmg-float');
                document.getElementById('display-view').classList.remove('hurt-flash');
                document.getElementById('boss-img').style.transform = "none";
            }, 1200);
        }
    }

    function updatePlayerView(state) {
        if(state.status === 'answering') {
            document.getElementById('player-waiting').classList.add('hidden');
            document.getElementById('player-q-zone').classList.remove('hidden');
            document.getElementById('p-title').innerText = questionBank[state.q].t;
            document.getElementById('p-q-timer').innerText = `â³ ${state.timeLeft}s`;
            const options = questionBank[state.q].o;
            document.getElementById('p-options').innerHTML = Object.entries(options).map(([k,v])=>
                `<button class="player-btn" style="margin-bottom:15px" onclick="submitAns('${k}')">${k}. ${v}</button>`
            ).join('');
        } else {
            document.getElementById('player-q-zone').classList.add('hidden');
            document.getElementById('player-waiting').classList.remove('hidden');
            document.getElementById('wait-msg').innerText = (state.status==='result') ? "ç™¼å‹•æ”»æ“Šä¸­ï¼ğŸ’¥" : "ç­‰å¾…æŒ‡æ®å®˜ä»»å‹™...";
        }
    }

    function changeQ(num) {
        db.ref('responses').remove();
        let timeLeft = 10;
        db.ref('gameState').update({ q: num, status: 'answering', timeLeft: timeLeft, resId: "" });
        const timer = setInterval(() => {
            timeLeft--;
            db.ref('gameState/timeLeft').set(timeLeft);
            if(timeLeft <= 0) clearInterval(timer);
        }, 1000);
    }

    function submitAns(ans) {
        db.ref('gameState/timeLeft').once('value', snap => {
            db.ref('responses/' + uid).set({ ans: ans, name: localStorage.getItem('boss_player_name'), timeLeft: snap.val() || 0 });
            document.getElementById('player-q-zone').classList.add('hidden');
            document.getElementById('player-waiting').classList.remove('hidden');
            document.getElementById('wait-msg').innerText = "å·²é€å‡ºç­”æ¡ˆï¼è«‹çœ‹å¤§è¢å¹•çµç®—...";
        });
    }

    function calculateResult() {
        db.ref().once('value', snap => {
            const data = snap.val();
            const resps = data.responses || {};
            const qNum = data.gameState.q;
            const qData = questionBank[qNum];
            const players = Object.values(resps);
            if(!players.length) return alert("æ²’äººå›ç­”ï¼");
            
            const dist = {A:0, B:0, C:0, D:0};
            players.forEach(p => dist[p.ans]++);
            const correctCount = (qData.a === "ALL") ? players.length : players.filter(p => p.ans === qData.a).length;
            const rate = correctCount / players.length;
            const dmg = Math.floor(BASE_DAMAGE * rate);
            
            db.ref('gameState').update({
                status: 'result',
                hp: Math.max(0, data.gameState.hp - dmg),
                lastDmg: dmg,
                correctRate: Math.round(rate * 100),
                distribution: dist,
                resId: "res-" + Date.now()
            });
            db.ref('history').push({ qNum: qNum, players: resps });
        });
    }

    function triggerBlessing() {
        db.ref('gameState').once('value', snap => {
            db.ref('gameState').update({
                hp: Math.max(0, snap.val().hp - 5000),
                lastDmg: 5000,
                status: 'result',
                showBlessing: true,
                customTalk: "é€™...é€™è‚¡å¼·å¤§çš„æ°£é‹æ˜¯æ€éº¼å›äº‹ï¼",
                resId: "bless-" + Date.now()
            });
        });
    }

    function findMVP() {
        db.ref('history').once('value', snap => {
            const history = snap.val(); if(!history) return;
            const scores = {}; 
            Object.values(history).forEach(round => {
                const correctAns = questionBank[round.qNum].a;
                Object.values(round.players).forEach(p => {
                    if(!scores[p.name]) scores[p.name] = { count: 0, totalTime: 0 };
                    if(correctAns === "ALL" || p.ans === correctAns) { 
                        scores[p.name].count++; 
                        scores[p.name].totalTime += (p.timeLeft || 0); 
                    }
                });
            });
            const sorted = Object.entries(scores).sort((a,b) => {
                if(b[1].count !== a[1].count) return b[1].count - a[1].count;
                return b[1].totalTime - a[1].totalTime;
            });
            document.getElementById('stat-area').classList.add('hidden');
            document.getElementById('mvp-announcement').classList.remove('hidden');
            document.getElementById('mvp-list').innerHTML = sorted.slice(0, 8).map((p, i) => 
                `<div style="display:flex; justify-content:space-between; padding:15px 40px; border-bottom:1px solid #444;"><span>No.${i+1} ${p[0]}</span><span style="color:var(--primary)">${p[1].count} é¡Œ | å‰©é¤˜ ${p[1].totalTime}s</span></div>`
            ).join('');
        });
    }

    function resetGame() {
        if(confirm("ç¢ºå®šè¦é‡ç½®ï¼Ÿé€™æœƒæ¸…ç©ºæ‰€æœ‰ç©å®¶èˆ‡æ­·å²ç´€éŒ„ï¼")) {
            db.ref('/').set({
                gameState: { q:0, status:'waiting', hp: BOSS_MAX_HP, timeLeft: 10 },
                resetTrigger: true
            });
        }
    }
</script>
</body>
</html>
