<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMDåœ˜çµä¸€å¿ƒ-Bosså¤§æŒ‘æˆ°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f39c12; --danger: #e74c3c; --success: #27ae60; }
        body { background: #121212; color: white; font-family: "PingFang TC", sans-serif; margin: 0; text-align: center; }
        .hidden { display: none !important; }
        
        /* BOSS & HP */
        #boss-container { position: relative; margin: 30px auto; min-height: 300px; }
        #boss-img { width: 300px; transition: 0.3s; filter: drop-shadow(0 0 20px rgba(255,255,255,0.1)); }
        #hp-wrapper { width: 80%; background: #222; height: 40px; border: 3px solid #fff; margin: 20px auto; border-radius: 20px; overflow: hidden; position: relative; }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff416c, #ff4b2b); transition: width 0.5s ease; }
        
        /* Damage Text */
        #dmg-text { position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; font-weight: 900; color: #ff3e3e; opacity: 0; pointer-events: none; z-index: 100; text-shadow: 2px 2px 10px #000; }
        .dmg-anim { animation: float-up 1s forwards; }
        @keyframes float-up { 0% { opacity: 1; transform: translate(-50%, 0) scale(1); } 100% { opacity: 0; transform: translate(-50%, -100px) scale(1.5); } }

        /* Buttons */
        .btn { background: linear-gradient(145deg, #f39c12, #e67e22); color: white; border: none; padding: 15px; font-size: 20px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px #d35400; }
        .btn:disabled { background: #555 !important; box-shadow: none; opacity: 0.6; cursor: not-allowed; }
        
        /* Layout */
        .q-card { background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; margin: 20px; border: 2px solid var(--primary); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        #name-overlay { position: fixed; inset: 0; background: #121212; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* Shakes */
        .hit-shake { animation: shake-kb 0.4s; }
        @keyframes shake-kb { 0% { transform: translate(2px, 1px) rotate(0deg); } 20% { transform: translate(-3px, -2px) rotate(-1deg); } 40% { transform: translate(-1px, 2px) rotate(1deg); } 60% { transform: translate(3px, 1px) rotate(0deg); } 100% { transform: translate(0,0); } }
    </style>
</head>
<body>

<div id="name-overlay" class="hidden">
    <h2 style="color: var(--primary);">ğŸ›¡ï¸ è«‹è¼¸å…¥æˆ°å£«ä»£è™Ÿ</h2>
    <input type="text" id="p-name-input" style="padding: 15px; font-size: 20px; border-radius: 10px; border: none; width: 250px; text-align: center;">
    <br><br>
    <button class="btn" style="width: 250px;" onclick="joinGame()">é€²å…¥æˆ°å ´</button>
</div>

<div id="view-display" class="hidden">
    <div style="display: flex; justify-content: space-around; align-items: center; padding: 20px;">
        <h1 id="d-round-title" style="color: var(--primary);">æº–å‚™æˆ°é¬¥</h1>
        <h1 id="d-timer" style="color: var(--danger); font-size: 50px;"></h1>
    </div>
    
    <div id="boss-container">
        <div id="dmg-text"></div>
        <img id="boss-img" src="Boss_normal.png">
    </div>

    <div id="hp-wrapper">
        <div id="hp-bar"></div>
        <div style="position:absolute; width:100%; top:0; line-height:40px; font-weight:bold;">
            HP: <span id="hp-val">10000</span> / 10000
        </div>
    </div>

    <div id="d-q-box" class="q-card hidden">
        <h2 id="d-question"></h2>
        <div class="grid" id="d-options" style="font-size: 24px;"></div>
    </div>
    
    <div id="d-stats" style="font-size: 24px; color: #f1c40f; margin-top: 20px;"></div>
</div>

<div id="view-player" class="hidden">
    <div id="p-waiting" style="margin-top: 40vh;">
        <h2 id="p-wait-msg">ç­‰å¾…æŒ‡æ®å®˜ç™¼å¸ƒæŒ‡ä»¤...</h2>
    </div>
    <div id="p-q-box" class="hidden">
        <div id="p-timer" style="font-size: 30px; color: var(--danger); font-weight: bold; margin: 10px;"></div>
        <h3 id="p-question" style="padding: 10px;"></h3>
        <div class="grid">
            <button class="btn q-btn" onclick="submitAns('A')">A. <span id="optA"></span></button>
            <button class="btn q-btn" onclick="submitAns('B')">B. <span id="optB"></span></button>
            <button class="btn q-btn" onclick="submitAns('C')">C. <span id="optC"></span></button>
            <button class="btn q-btn" onclick="submitAns('D')">D. <span id="optD"></span></button>
        </div>
    </div>
</div>

<div id="view-admin" class="hidden" style="padding: 20px;">
    <h2>æŒ‡æ®å®˜æ§åˆ¶é¢æ¿</h2>
    <div id="admin-btns" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px;"></div>
    <button onclick="calcResult()" style="background:var(--success); color:white; padding: 20px; font-size: 24px; width: 100%; border-radius: 10px; border:none; cursor: pointer;">ğŸ’¥ å…¨å“¡ç™¼å‹•æ”»æ“Šï¼</button>
    <br><br>
    <button onclick="resetSystem()" style="background:#444; color:#ccc; border:none; padding:10px; cursor:pointer;">ğŸ’£ ç³»çµ±å®Œæ•´é‡ç½®</button>
</div>

<script>
// --- åˆå§‹åŒ–èˆ‡è¨­å®š ---
const firebaseConfig = {
    apiKey: "AIzaSyDwwKME2_neH-VxZObTStJ_uRuJI_-C-tw",
    authDomain: "department-boss-battle.firebaseapp.com",
    databaseURL: "https://department-boss-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "department-boss-battle",
    storageBucket: "department-boss-battle.firebasestorage.app",
    messagingSenderId: "112990000902",
    appId: "1:112990000902:web:5b003355322134537e3087"
};

const BOSS_MAX_HP = 10000;
const BASE_DMG = 1000;
const questionBank = {
    1: { t: "ä»Šå¤©QMD Kick Off çš„ä¸»æŒäººå¸¥å—?", o: {A:"å®‡å®™å¸¥", B:"å¤ªé™½ç³»å¸¥", C:"éŠ€æ²³ç³»å¸¥", D:"é˜¿æ ¼åŠ›"}, a: "ABC" },
    2: { t: "ä»Šå¹´QMD Kick Offæƒ³è¦è¡¨é”çš„ä¸»é¡Œç‚ºä½•?", o: {A:"Collaborating Forward Executing Together", B:"å”åšå‰è¡Œï¼Œé½Šå¿ƒè‡´é ", C:"ä¸€å€‹äººèµ°çš„å¿«ï¼Œä¸€ç¾¤äººèµ°å¾—é ", D:"ä»¥ä¸Šçš†æ˜¯"}, a: "D" },
    3: { t: "ä¸‹åˆ—ä½•è€…ä¸æ˜¯CMCå°æ–¼E2Eæ–™ä»¶ç®¡ç†çš„ä¸‰å¤§é‡é»?", o: {A:"ç™¼å±•æ–™å€ç®¡ç†", B:"å›æ‡‰å¤–éƒ¨è­°é¡Œ", C:"ç™¼å±•é¢¨éšªç¶­åº¦", D:"ä»¥æˆæœ¬ç•¶ä½œå„ªå…ˆè©•ä¼°é‡é»"}, a: "D" },
    4: { t: "ä½•è€…ä¸æ˜¯PPAPçš„æ ¸å¿ƒé‡é»?", o: {A:"è¦æ ¼åˆ¶è¨‚&è½åœ°åŸ·è¡Œ", B:"ç•°å¸¸è™•ç†&å•é¡Œè§£æ", C:"ç­–ç•¥åŸ·è¡Œ&å“è³ªæå‡", D:"ç­†&é³³æ¢¨&è˜‹æœ"}, a: "D" },
    5: { t: "ä½•è€…ä¸æ˜¯é›»å­èˆ‡æ¨¡çµ„æ–™å€å°çµ„åœ¨2026å¹´çš„é‡é»å·¥ä½œ?", o: {A:"DRAM & Main chipå°è£ç”¢èƒ½è¡æ“Šå°æ‡‰", B:"é‘½ç ”AIç¡¬é«”æ‡‰ç”¨è¶¨å‹¢", C:"é€éPFMEAæ°´å¹³å±•é–‹æå‡æ¿å» å·¥ç¨‹èƒ½åŠ›", D:"è½å¯¦ Power é¸æ–™åŸå‰‡ï¼Œæ¨è¡Œå–®é«”é©—è­‰"}, a: "B" },
    6: { t: "ä¸‹åˆ—ä½•è€…ä¸æ˜¯DQA 2026çš„ä¸‰å¤§æ ¸å¿ƒè½‰å‹?", o: {A:"æ•ˆç‡é©å‘½", B:"åƒ¹å€¼æå‡", C:"çµ„ç¹”é‡çµ„", D:"å¢è³¼è¨­å‚™"}, a: "D" },
    7: { t: "TKçš„ç²¾ç¾å ±å‘Šæ˜¯ä½¿ç”¨äº†ä¸‹åˆ—å“ªå€‹AIå¹³å°è¼”åŠ©è£½ä½œ?", o: {A:"Grok", B:"ChatGPT", C:"NotebookLM", D:"Perplexity"}, a: "D" },
    8: { t: "DPQMçš„é—œéµä»»å‹™-æ•¸ä½åŒ–è½‰å‹æ˜¯è‡ªå‹•åŒ–ç”¢å‡ºä¸‹åˆ—ä½•è€…å ±å‘Š?", o: {A:"æ¸¬è©¦å ±å‘Šèˆ‡MTBFå ±å‘Š", B:"DFEMA", C:"8Då ±å‘Š", D:"PFEMAå ±å‘Š"}, a: "A" },
    9: { t: "Which is not one of the Strategies Pillars of PRCM?", o: {A:"Enhance Sustaining", B:"Better Service for Customer", C:"Build up Engineering Knowledge", D:"Pneumonoultra...volcanoconiosis"}, a: "D" },
    10: { t: "Where the Knowledge Management of PRCM is?", o: {A:"GeDCC", B:"PDM", C:"PRCM Portal", D:"Moxa College"}, a: "C" },
    11: { t: "Which of the following is not Hard Skill of PRCM?", o: {A:"EMC&RF", B:"Safty&Hazloc", C:"Energy&Haz Substances", D:"Ontology&Epistemology"}, a: "D" },
    12: { t: "å“è³ªèˆ‡å¯é åº¦ç™½çš®æ›¸é è¨ˆç”šéº¼æ™‚å€™æ­£å¼ç™¼å¸ƒ?", o: {A:"2026Q4", B:"å·²ç¶“å®Œæˆæ­£å¼ç™¼ä½ˆ", C:"2027Q3", D:"2027Q2"}, a: "A" },
    13: { t: "ä½•è€…ä¸æ˜¯2025å¹´çš„å¯é åº¦å°ˆæ¡ˆ?", o: {A:"Nport 6150 Reliability", B:"Thin Gold Plated Contacts Effect", C:"PCB Supplier EISO enhancement", D:"Solder joint 20Y Reliability Test"}, a: "B" },
    14: { t: "ä½•è€…ä¸æ˜¯QRM 2026çš„æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•«?", o: {A:"Conformal Coating BGA æ‡‰åŠ›å½±éŸ¿", B:"è–„é‡‘éå±¤æ¥è§¸å½±éŸ¿", C:"å£“é›»ææ–™æ•£ç†±å¯é åº¦", D:"ç”¢å“PELï¼šé›»è§£é›»å®¹é©—è­‰"}, a: "B" },
    15: { t: "å“ªä½åŒä»é€£çºŒå¹¾å¹´åƒèˆ‡è¡¨æ¼”ï¼Œä»Šå¹´ä¹Ÿæœƒé–ƒäº®ç™»å°?", o: {A:"Jerry", B:"Lisa", C:"Boozer", D:"Dennis"}, a: "A" }
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const urlParams = new URLSearchParams(window.location.search);
const role = urlParams.get('role') || 'player';
const uid = localStorage.getItem('game_uid') || Math.random().toString(36).substr(2, 9);
localStorage.setItem('game_uid', uid);

// --- ä»‹é¢åˆ‡æ› ---
if(role === 'admin') {
    document.getElementById('view-admin').classList.remove('hidden');
    const container = document.getElementById('admin-btns');
    for(let i=1; i<=15; i++) {
        container.innerHTML += `<button onclick="launchQ(${i})" style="padding:10px;">é¡Œ${i}</button>`;
    }
} else if(role === 'display') {
    document.getElementById('view-display').classList.remove('hidden');
} else {
    document.getElementById('view-player').classList.remove('hidden');
    if(!localStorage.getItem('p_name')) {
        document.getElementById('name-overlay').classList.remove('hidden');
    } else {
        db.ref('players/' + uid).set(localStorage.getItem('p_name'));
    }
}

// --- é‚è¼¯åŠŸèƒ½ ---
let hasSubmitted = false;
let currentQIdx = -1;
let lastResId = "";

function joinGame() {
    const name = document.getElementById('p-name-input').value.trim();
    if(!name) return;
    localStorage.setItem('p_name', name);
    db.ref('players/' + uid).set(name);
    document.getElementById('name-overlay').classList.add('hidden');
}

// æ ¸å¿ƒç›£è½
db.ref('gameState').on('value', snap => {
    const state = snap.val() || { hp: BOSS_MAX_HP, status: 'waiting', q: 0 };
    
    // æª¢æŸ¥é¡Œç›®æ˜¯å¦åˆ‡æ›
    if(state.q !== currentQIdx) {
        currentQIdx = state.q;
        hasSubmitted = false;
        if(role === 'player') {
            document.querySelectorAll('.q-btn').forEach(b => b.disabled = false);
        }
    }

    // æ¸²æŸ“ HP
    document.getElementById('hp-bar').style.width = (state.hp / BOSS_MAX_HP * 100) + "%";
    document.getElementById('hp-val').innerText = state.hp;

    const timerText = state.timeLeft > 0 ? `â³ ${state.timeLeft}s` : "âŒ› æ™‚é–“åˆ°";

    if(role === 'display') {
        document.getElementById('d-timer').innerText = state.status === 'answering' ? timerText : "";
        db.ref('players').once('value', pSnap => {
            db.ref('responses').once('value', rSnap => {
                const total = pSnap.numChildren();
                const ready = rSnap.numChildren();
                document.getElementById('d-stats').innerText = state.status === 'answering' ? `ä½œç­”äººæ•¸: ${ready} / ${total}` : `é›†çµäººæ•¸: ${total}`;
            });
        });

        if(state.status === 'answering') {
            const q = questionBank[state.q];
            document.getElementById('d-q-box').classList.remove('hidden');
            document.getElementById('d-question').innerText = q.t;
            document.getElementById('d-options').innerHTML = `<div>A: ${q.o.A}</div><div>B: ${q.o.B}</div><div>C: ${q.o.C}</div><div>D: ${q.o.D}</div>`;
        } else if (state.status === 'result' && state.resId !== lastResId) {
            lastResId = state.resId;
            showAttack(state.lastDmg, state.rate);
        }
    }

    if(role === 'player') {
        if(state.status === 'answering' && !hasSubmitted) {
            const q = questionBank[state.q];
            document.getElementById('p-waiting').classList.add('hidden');
            document.getElementById('p-q-box').classList.remove('hidden');
            document.getElementById('p-question').innerText = q.t;
            document.getElementById('optA').innerText = q.o.A;
            document.getElementById('optB').innerText = q.o.B;
            document.getElementById('optC').innerText = q.o.C;
            document.getElementById('optD').innerText = q.o.D;
            document.getElementById('p-timer').innerText = timerText;
            if(state.timeLeft <= 0) document.querySelectorAll('.q-btn').forEach(b => b.disabled = true);
        } else {
            document.getElementById('p-q-box').classList.add('hidden');
            document.getElementById('p-waiting').classList.remove('hidden');
            document.getElementById('p-wait-msg').innerText = hasSubmitted ? "âœ… æ”»æ“Šæº–å‚™ä¸­..." : "ç­‰å¾…æŒ‡ä»¤...";
        }
    }
});

function showAttack(dmg, rate) {
    document.getElementById('d-q-box').classList.add('hidden');
    if(dmg > 0) {
        const dText = document.getElementById('dmg-text');
        dText.innerText = `-${dmg}`;
        dText.classList.remove('dmg-anim');
        void dText.offsetWidth;
        dText.classList.add('dmg-anim');
        document.getElementById('boss-img').classList.add('hit-shake');
        setTimeout(() => document.getElementById('boss-img').classList.remove('hit-shake'), 500);
    }
    document.getElementById('d-stats').innerHTML = `<div style="font-size:40px;">æˆåŠŸç‡: ${rate}% <br> å‚·å®³: ${dmg}</div>`;
}

// --- æ§åˆ¶åŠŸèƒ½ ---
function launchQ(num) {
    db.ref('responses').remove();
    let sec = 10;
    db.ref('gameState').update({ q: num, status: 'answering', timeLeft: sec, resId: "" });
    const timer = setInterval(() => {
        sec--;
        db.ref('gameState/timeLeft').set(sec);
        if(sec <= 0) clearInterval(timer);
    }, 1000);
}

function submitAns(ans) {
    hasSubmitted = true;
    db.ref('responses/' + uid).set({ ans: ans });
}

function calcResult() {
    db.ref().once('value', snap => {
        const data = snap.val();
        const resps = Object.values(data.responses || {});
        const qIdx = data.gameState.q;
        if(!resps.length || qIdx === 0) return alert("ç„¡äººä½œç­”æˆ–æœªé¸æ“‡é¡Œç›®");

        const correctAns = questionBank[qIdx].a;
        const correctCount = resps.filter(r => correctAns.includes(r.ans)).length;
        const rate = Math.round((correctCount / resps.length) * 100);
        const dmg = Math.floor((rate / 100) * BASE_DMG);

        db.ref('gameState').update({
            status: 'result',
            hp: Math.max(0, data.gameState.hp - dmg),
            lastDmg: dmg,
            rate: rate,
            resId: "R" + Date.now()
        });
    });
}

function resetSystem() {
    if(!confirm("ç¢ºå®šé‡ç½®ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰ç©å®¶æ•¸æ“š")) return;
    db.ref('/').set({
        gameState: { q: 0, hp: BOSS_MAX_HP, status: 'waiting', timeLeft: 0, resId: "" },
        players: null,
        responses: null
    }).then(() => location.reload());
}
</script>
</body>
</html>
