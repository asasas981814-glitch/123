<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA éƒ¨é–€å¤§ä½œæˆ° - BOSS BATTLE</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f39c12; --danger: #e74c3c; --success: #27ae60; }
        body { background: #121212; color: white; font-family: "PingFang TC", sans-serif; margin: 0; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        /* å¤§è¢å¹•ç‰¹æ•ˆ */
        #display-view { padding: 20px; transition: background 0.3s; }
        .hurt-flash { background: rgba(231, 76, 60, 0.3) !important; }
        
        .q-card { background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px; margin: 20px auto; max-width: 800px; border: 2px solid var(--primary); box-shadow: 0 0 20px var(--primary); }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; font-size: 24px; }
        
        /* Boss å®¹å™¨èˆ‡å‹•ç•« */
        #boss-container { position: relative; display: inline-block; margin: 20px; }
        #boss-img { width: 300px; transition: all 0.5s ease-out; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); }
        .shake { animation: heavy-shake 0.5s both; }
        @keyframes heavy-shake {
            0%, 100% {transform: translateX(0);}
            20% {transform: translateX(-15px) rotate(-5deg);}
            40% {transform: translateX(15px) rotate(5deg);}
            60% {transform: translateX(-15px) rotate(-5deg);}
            80% {transform: translateX(15px) rotate(5deg);}
        }
        
        #dmg-text { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 60px; font-weight: bold; color: #ff4b2b; text-shadow: 2px 2px 10px black; opacity: 0; pointer-events: none; }
        .dmg-float { animation: float-up 1.2s ease-out; }
        @keyframes float-up {
            0% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -100px); }
        }

        #hp-wrapper { width: 80%; background: #333; height: 35px; border: 3px solid white; margin: 10px auto; border-radius: 20px; overflow: hidden; box-shadow: 0 0 15px rgba(255,0,0,0.5); }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff416c, #ff4b2b); transition: width 1s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        
        .player-btn { background: linear-gradient(145deg, #f39c12, #e67e22); color: white; border: none; padding: 25px; font-size: 22px; border-radius: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 5px #d35400; width: 100%; }
        .player-btn:active { box-shadow: 0 2px #d35400; transform: translateY(3px); }
    </style>
</head>
<body>

<div id="player-view" class="hidden">
    <div id="player-waiting" style="margin-top: 150px;">
        <h2>âš¡ æº–å‚™é›†æ°£ âš¡</h2>
        <p id="wait-msg">ç­‰å¾…ä¸»æŒäººç™¼å¸ƒé¡Œç›®...</p>
    </div>
    <div id="player-q-zone" class="hidden">
        <h3 id="p-title">é¡Œç›®è¼‰å…¥ä¸­...</h3>
        <div class="btn-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px;">
            <button class="player-btn" onclick="submitAns('A')">A. <span id="pa"></span></button>
            <button class="player-btn" onclick="submitAns('B')">B. <span id="pb"></span></button>
            <button class="player-btn" onclick="submitAns('C')">C. <span id="pc"></span></button>
            <button class="player-btn" onclick="submitAns('D')">D. <span id="pd"></span></button>
        </div>
    </div>
</div>

<div id="display-view" class="hidden">
    <h1 id="round-num" style="font-size: 40px; margin-bottom: 0;">READY?</h1>
    <div id="boss-container">
        <div id="dmg-text"></div>
        <img id="boss-img" src="Boss.png">
    </div>
    <div id="hp-wrapper"><div id="hp-bar"></div></div>
    <div id="hp-info" style="font-weight: bold; font-size: 28px;">HP: 12000 / 12000</div>
    
    <div id="display-q-box" class="q-card hidden">
        <h2 id="d-title" style="margin-top:0;"></h2>
        <div class="option-grid" id="d-options"></div>
    </div>
    <div id="msg-box" style="font-size: 32px; color: #f1c40f; margin-top: 10px; height: 50px;"></div>
    <div id="vote-count" style="color: #888;">å·²åŠ å…¥äººæ•¸: 0</div>
</div>

<div id="admin-view" class="hidden">
    <h2>æŒ‡æ®å®˜å¾Œå°</h2>
    <div style="background:#333; padding:10px; margin:10px; border-radius:10px;" id="admin-btns"></div>
    <div style="padding:20px;">
        <button onclick="calculateResult()" style="background:var(--success); color:white; width:100%; padding:20px; font-size:24px; border:none; border-radius:10px; cursor:pointer;">ğŸ’¥ ç™¼å‹•æ”»æ“Šï¼</button>
        <button onclick="resetGame()" style="margin-top:30px; background:#555; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">é‡ç½®éŠæˆ²</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDwwKME2_neH-VxZObTStJ_uRuJI_-C-tw",
        authDomain: "department-boss-battle.firebaseapp.com",
        databaseURL: "https://department-boss-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "department-boss-battle",
        storageBucket: "department-boss-battle.firebasestorage.app",
        messagingSenderId: "112990000902",
        appId: "1:112990000902:web:5b003355322134537e3087"
    };

    const questionBank = {
        1: { t: "è«‹å•ä¸»æŒäººå¸¥å—?", o: {A:"å¸¥", B:"å¾ˆå¸¥", C:"è¶…å¸¥", D:"ç‰¹åˆ¥å¸¥"}, a: "ALL" },
        2: { t: "Moxaåœ¨å“ªè£¡?", o: {A:"æ¿æ©‹", B:"æ–°èŠ", C:"ä¸­å’Œ", D:"æ°¸å’Œ"}, a: "B" },
        3: { t: "æˆ‘å€‘æ˜¯ç”šéº¼è‚¡ä»½æœ‰é™å…¬å¸?", o: {A:"101", B:"202", C:"303", D:"404"}, a: "D" },
        4: { t: "CEå…¨ç¨±?", o: {A:"Common Era", B:"Civil Engineer", C:"Component Engineer", D:"Computer Engineer"}, a: "C" },
        5: { t: "ä»Šå¹´å¼·èª¿çš„ä¸»é¡Œæ˜¯?", o: {A:"å”ä½œ", B:"å”åŠ›è»Š", C:"å­«å”å¿—", D:"å”å”å”"}, a: "A" },
        6: { t: "CAæœ€æ‰›çš„ç”·äººæ˜¯èª°?", o: {A:"Boozer", B:"Booger", C:"Booder", D:"Booker"}, a: "A" },
        7: { t: "CEå¤©æ‰ç•«æ‰‹æ˜¯èª°?", o: {A:"Daneil", B:"Dennis", C:"Demmis", D:"Deccis"}, a: "B" },
        8: { t: "CAè¬ è¨€è£½é€ è€…æ˜¯èª°?", o: {A:"Naoh", B:"Nhao", C:"Noah", D:"Noha"}, a: "C" },
        9: { t: "CAä¹‹æ¯æ˜¯èª°?", o: {A:"Lica", B:"Lisa", C:"Liya", D:"Liwa"}, a: "B" },
        10: { t: "CAå°çŒ´æ˜¯èª°?", o: {A:"Tiffiya", B:"Tiffant", C:"Tiffjia", D:"Tiffany"}, a: "D" }
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const role = new URLSearchParams(window.location.search).get('role') || 'player';

    if(role === 'admin') {
        document.getElementById('admin-view').classList.remove('hidden');
        const container = document.getElementById('admin-btns');
        for(let i=1; i<=10; i++) container.innerHTML += `<button onclick="changeQ(${i})" style="margin:5px; padding:10px;">é¡Œ${i}</button>`;
    } else if(role === 'display') {
        document.getElementById('display-view').classList.remove('hidden');
    } else {
        document.getElementById('player-view').classList.remove('hidden');
    }

    db.ref('gameState').on('value', (snap) => {
        const state = snap.val() || { q: 0, status: 'waiting', hp: 12000 };
        const qData = questionBank[state.q];

        if(role === 'display') {
            const hpBar = document.getElementById('hp-bar');
            const hpInfo = document.getElementById('hp-info');
            const bossImg = document.getElementById('boss-img');
            
            hpBar.style.width = (state.hp / 12000 * 100) + "%";
            hpInfo.innerText = `HP: ${state.hp} / 12000`;

            // ç‹€æ…‹æ•ˆæœï¼šè¡€é‡ä½æ–¼ 50% è®Šç´…
            if(state.hp <= 6000 && state.hp > 0) {
                bossImg.style.filter = "sepia(1) saturate(3) hue-rotate(-50deg) drop-shadow(0 0 15px red)";
            } else if(state.hp <= 0) {
                // å‹åˆ©ç‰¹æ•ˆ
                bossImg.style.transform = "scale(0) rotate(720deg)";
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            } else {
                bossImg.style.filter = "drop-shadow(0 0 10px rgba(255,255,255,0.2))";
            }

            if(state.status === 'answering' && qData) {
                document.getElementById('round-num').innerText = `ROUND ${state.q}`;
                document.getElementById('display-q-box').classList.remove('hidden');
                document.getElementById('d-title').innerText = qData.t;
                document.getElementById('d-options').innerHTML = `<div>A: ${qData.o.A}</div><div>B: ${qData.o.B}</div><div>C: ${qData.o.C}</div><div>D: ${qData.o.D}</div>`;
            } else if(state.status === 'result') {
                document.getElementById('display-q-box').classList.add('hidden');
                if(state.lastDmg > 0) {
                    bossImg.classList.add('shake');
                    const dmgText = document.getElementById('dmg-text');
                    dmgText.innerText = `-${state.lastDmg}`;
                    dmgText.classList.add('dmg-float');
                    document.getElementById('display-view').classList.add('hurt-flash');
                    
                    setTimeout(() => {
                        bossImg.classList.remove('shake');
                        dmgText.classList.remove('dmg-float');
                        document.getElementById('display-view').classList.remove('hurt-flash');
                    }, 1000);
                }
                document.getElementById('msg-box').innerText = `ç­”å°ç‡ ${state.lastRate}%ï¼ é€ æˆ ${state.lastDmg} å‚·å®³ï¼`;
            }
        }

        if(role === 'player') {
            const waiting = document.getElementById('player-waiting');
            const zone = document.getElementById('player-q-zone');
            if(state.status === 'answering' && qData) {
                waiting.classList.add('hidden');
                zone.classList.remove('hidden');
                document.getElementById('p-title').innerText = qData.t;
                document.getElementById('pa').innerText = qData.o.A; 
                document.getElementById('pb').innerText = qData.o.B;
                document.getElementById('pc').innerText = qData.o.C; 
                document.getElementById('pd').innerText = qData.o.D;
            } else {
                waiting.classList.remove('hidden');
                zone.classList.add('hidden');
                if(state.status === 'result') document.getElementById('wait-msg').innerText = "çµç®—ä¸­...è«‹çœ‹å¤§è¢å¹•ï¼";
                else document.getElementById('wait-msg').innerText = "ç­‰å¾…ä¸»æŒäººç™¼å¸ƒé¡Œç›®...";
            }
        }
    });

    db.ref('responses').on('value', snap => {
        if(role === 'display') document.getElementById('vote-count').innerText = `å·²æŠ•ç¥¨äººæ•¸: ${snap.numChildren()}`;
    });

    function changeQ(q) {
        db.ref('responses').remove();
        db.ref('gameState').update({ q: q, status: 'answering', lastDmg: 0 });
    }

    function submitAns(ans) {
        const uid = localStorage.getItem('game_uid') || Math.random().toString(36).substring(7);
        localStorage.setItem('game_uid', uid);
        db.ref('responses/' + uid).set(ans);
        document.getElementById('player-q-zone').classList.add('hidden');
        document.getElementById('player-waiting').classList.remove('hidden');
        document.getElementById('wait-msg').innerText = "å·²æˆåŠŸé›†æ°£ï¼ç­‰å¾…æ”»æ“Š...";
    }

    function calculateResult() {
        db.ref().once('value', snap => {
            const data = snap.val();
            const qData = questionBank[data.gameState.q];
            const resps = Object.values(data.responses || {});
            if(resps.length === 0) return alert("æ²’äººæŠ•ç¥¨ï¼");

            let correct = (qData.a === "ALL") ? resps.length : resps.filter(a => a === qData.a).length;
            const rate = (correct / resps.length) * 100;
            
            let dmg = 100;
            if(rate > 20) dmg = 300;
            if(rate > 40) dmg = 600;
            if(rate > 60) dmg = 1000;
            if(rate > 80) dmg = 1500;
            
            if(Math.random() < 0.1) { dmg *= 2; }

            db.ref('gameState').update({
                status: 'result',
                hp: Math.max(0, data.gameState.hp - dmg),
                lastDmg: dmg,
                lastRate: rate.toFixed(1)
            });
        });
    }

    function resetGame() {
        if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) db.ref('/').set({ gameState: { q:0, status:'waiting', hp:12000, lastDmg:0 } });
    }
</script>
</body>
</html>
