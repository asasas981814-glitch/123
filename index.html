<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QMDåœ˜çµä¸€å¿ƒ-Bosså¤§æŒ‘æˆ°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #f39c12; --danger: #e74c3c; --success: #27ae60; --disabled: #555; }
        body { background: #121212; color: white; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; margin: 0; overflow-x: hidden; }
        .hidden { display: none !important; }
        
        #display-view { padding: 20px; text-align: center; transition: background 0.2s; }
        .hurt-flash { background: rgba(231, 76, 60, 0.5) !important; }
        
        #boss-container { position: relative; display: inline-block; margin: 40px auto; min-height: 320px; }
        #boss-img { width: 320px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); filter: drop-shadow(0 0 20px rgba(255,255,255,0.2)); }
        
        #boss-bubble {
            position: absolute; top: -10px; right: -160px; background: white; color: black; 
            padding: 15px 20px; border-radius: 20px; font-weight: bold; font-size: 20px;
            max-width: 240px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 3px solid #333;
            z-index: 50; display: none; text-align: left; animation: bubble-pop 0.3s ease-out;
        }
        #boss-bubble::after { content: ''; position: absolute; left: -20px; top: 40%; border: 10px solid transparent; border-right-color: white; }
        @keyframes bubble-pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .shake { animation: heavy-shake 0.5s both; }
        @keyframes heavy-shake { 0%, 100% {transform: translateX(0);} 20% {transform: translateX(-15px) rotate(-5deg);} 40% {transform: translateX(15px) rotate(5deg);} 60% {transform: translateX(-15px) rotate(-5deg);} 80% {transform: translateX(15px) rotate(5deg);} }
        .screen-shake { animation: screen-shake-anim 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes screen-shake-anim { 10%, 90% { transform: translate3d(-4px, 0, 0); } 20%, 80% { transform: translate3d(6px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-10px, 0, 0); } 40%, 60% { transform: translate3d(10px, 0, 0); } }

        #hp-wrapper { width: 85%; background: #222; height: 45px; border: 4px solid #fff; margin: 20px auto; border-radius: 25px; overflow: hidden; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff416c, #ff4b2b); transition: width 0.8s ease-out; }

        #dmg-text { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); font-size: 80px; font-weight: 900; color: #ff3e3e; opacity: 0; pointer-events: none; z-index: 100; text-shadow: 4px 4px 0 #000, 0 0 20px #fff; }
        .dmg-float { animation: float-up 1.2s forwards; }
        @keyframes float-up { 0% { opacity: 1; transform: translate(-50%, 0) scale(0.8); } 50% { transform: translate(-50%, -60px) scale(1.3); } 100% { opacity: 0; transform: translate(-50%, -120px) scale(1); } }

        .q-card { background: rgba(0,0,0,0.9); padding: 30px; border-radius: 20px; margin: 20px auto; max-width: 900px; border: 3px solid var(--primary); box-shadow: 0 0 30px rgba(243, 156, 18, 0.4); }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; font-size: 28px; text-align: left; }
        
        .player-btn { background: linear-gradient(145deg, #f39c12, #e67e22); color: white; border: none; padding: 20px; font-size: 24px; border-radius: 20px; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 5px #d35400; transition: all 0.2s; }
        .player-btn:active { transform: translateY(3px); box-shadow: 0 2px #d35400; }
        .player-btn:disabled { background: #555 !important; box-shadow: none !important; cursor: not-allowed; opacity: 0.6; }
        #name-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<audio id="game-bgm" src="BGM.mp3" loop></audio>

<div id="name-overlay" class="hidden">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; width: 85%;">
        <h2 style="color: var(--primary); font-size: 32px;">ğŸ›¡ï¸ æˆ°å£«åŠ å…¥æˆ°å ´ ğŸ›¡ï¸</h2>
        <input type="text" id="player-name-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—..." style="width: 100%; max-width: 300px; padding: 18px; font-size: 20px; border-radius: 15px; background: #222; color: white; text-align: center; border: 2px solid var(--primary);">
        <button class="player-btn" onclick="saveName()">åŠ å…¥æˆ°é¬¥</button>
    </div>
</div>

<div id="player-view" class="hidden">
    <div id="player-waiting" style="margin-top: 150px; text-align: center;">
        <h2 id="wait-status" style="font-size: 32px;">æº–å‚™ä¸­...</h2>
        <p id="wait-msg" style="font-size: 22px; color: #f1c40f;">ç­‰å¾…æŒ‡æ®å®˜ç™¼å¸ƒä»»å‹™...</p>
    </div>
    <div id="player-q-zone" class="hidden">
        <div id="p-q-timer" style="text-align: center; font-size: 30px; color: #e74c3c; font-weight: bold; margin-bottom: 10px;">â³ 10s</div>
        <h3 id="p-title" style="text-align: center; font-size: 28px; padding: 10px;"></h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
            <button class="player-btn q-btn" id="btnA" onclick="submitAns('A')">A. <span id="pa"></span></button>
            <button class="player-btn q-btn" id="btnB" onclick="submitAns('B')">B. <span id="pb"></span></button>
            <button class="player-btn q-btn" id="btnC" onclick="submitAns('C')">C. <span id="pc"></span></button>
            <button class="player-btn q-btn" id="btnD" onclick="submitAns('D')">D. <span id="pd"></span></button>
        </div>
    </div>
</div>

<div id="display-view" class="hidden">
    <button id="bgm-control" onclick="toggleBGM()" style="position:fixed; bottom:20px; right:20px; padding:10px; z-index:1000;">ğŸµ å•Ÿå‹•éŸ³æ•ˆ</button>
    <div style="display: flex; justify-content: center; align-items: center; gap: 30px;">
        <h1 id="round-num" style="font-size: 55px; color: var(--primary);">READY?</h1>
        <div id="d-timer" style="font-size: 55px; font-weight: bold; color: #e74c3c;"></div>
    </div>
    
    <div id="boss-container">
        <div id="boss-bubble"></div> <div id="dmg-text"></div>
        <img id="boss-img" src="Boss_normal.png">
    </div>

    <div id="hp-wrapper">
        <div id="hp-bar"></div>
        <div style="position: absolute; width:100%; top:0; line-height:45px; font-weight:900; font-size: 24px;">HP: <span id="hp-text">10000</span> / 10000</div>
    </div>

    <div id="display-q-box" class="q-card hidden">
        <h2 id="d-title" style="font-size: 40px;"></h2>
        <div class="option-grid" id="d-options"></div>
    </div>

    <div id="msg-box" style="margin-top: 20px;"></div>
    <div id="vote-count" style="color: #f1c40f; font-size: 28px; font-weight: bold;">å·²é›†çµæˆ°å£«: 0</div>
</div>

<div id="admin-view" class="hidden" style="text-align: center; padding: 20px;">
    <h2>æŒ‡æ®å®˜é¢æ¿</h2>
    <div id="admin-btns" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px;"></div>
    <button onclick="calculateResult()" style="background:var(--success); color:white; width:85%; padding:25px; font-size:32px; border-radius:15px; border:none; font-weight: bold; cursor: pointer;">ğŸ’¥ å…¨å“¡ç™¼å‹•æ”»æ“Šï¼</button>
    <br><br>
    <button onclick="resetGame()" style="background:#c0392b; color:white; padding:10px 20px; border:none; border-radius:5px; cursor: pointer;">ğŸ’£ é‡ç½®æˆ°å ´ (å…¨é«”åˆ·æ–°)</button>
</div>

<script>
    const BOSS_MAX_HP = 10000;
    const BASE_DAMAGE = 1000;
    const firebaseConfig = {
        apiKey: "AIzaSyDwwKME2_neH-VxZObTStJ_uRuJI_-C-tw",
        authDomain: "department-boss-battle.firebaseapp.com",
        databaseURL: "https://department-boss-battle-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "department-boss-battle",
        storageBucket: "department-boss-battle.firebasestorage.app",
        messagingSenderId: "112990000902",
        appId: "1:112990000902:web:5b003355322134537e3087"
    };

    const questionBank = {
        1: { t: "ä»Šå¤©QMD Kick Off çš„ä¸»æŒäººå¸¥å—?", o: {A:"å®‡å®™å¸¥", B:"å¤ªé™½ç³»å¸¥", C:"éŠ€æ²³ç³»å¸¥", D:"é˜¿æ ¼åŠ›"}, a: "ABC" },
        2: { t: "ä»Šå¹´QMD Kick Offæƒ³è¦è¡¨é”çš„ä¸»é¡Œç‚ºä½•?", o: {A:"Collaborating Forward Executing Together", B:"å”åšå‰è¡Œï¼Œé½Šå¿ƒè‡´é ", C:"ä¸€å€‹äººèµ°çš„å¿«ï¼Œä¸€ç¾¤äººèµ°å¾—é ", D:"ä»¥ä¸Šçš†æ˜¯"}, a: "D" },
        3: { t: "ä¸‹åˆ—ä½•è€…ä¸æ˜¯CMCå°æ–¼E2Eæ–™ä»¶ç®¡ç†çš„ä¸‰å¤§é‡é»?", o: {A:"ç™¼å±•æ–™å€ç®¡ç†", B:"å›æ‡‰å¤–éƒ¨è­°é¡Œ", C:"ç™¼å±•é¢¨éšªç¶­åº¦", D:"ä»¥æˆæœ¬ç•¶ä½œå„ªå…ˆè©•ä¼°é‡é»"}, a: "D" },
        4: { t: "ä½•è€…ä¸æ˜¯PPAPçš„æ ¸å¿ƒé‡é»?", o: {A:"è¦æ ¼åˆ¶è¨‚&è½åœ°åŸ·è¡Œ", B:"ç•°å¸¸è™•ç†&å•é¡Œè§£æ", C:"ç­–ç•¥åŸ·è¡Œ&å“è³ªæå‡", D:"ç­†&é³³æ¢¨&è˜‹æœ"}, a: "D" },
        5: { t: "ä½•è€…ä¸æ˜¯é›»å­èˆ‡æ¨¡çµ„æ–™å€å°çµ„åœ¨2026å¹´çš„é‡é»å·¥ä½œ?", o: {A:"DRAM & Main chipå°è£ç”¢èƒ½è¡æ“Šå°æ‡‰", B:"é‘½ç ”AIç¡¬é«”æ‡‰ç”¨è¶¨å‹¢", C:"é€éPFMEAæ°´å¹³å±•é–‹æå‡æ¿å» å·¥ç¨‹èƒ½åŠ›", D:"è½å¯¦ Power é¸æ–™åŸå‰‡ï¼Œæ¨è¡Œå–®é«”é©—è­‰"}, a: "B" },
        6: { t: "ä¸‹åˆ—ä½•è€…ä¸æ˜¯DQA 2026çš„ä¸‰å¤§æ ¸å¿ƒè½‰å‹?", o: {A:"æ•ˆç‡é©å‘½", B:"åƒ¹å€¼æå‡", C:"çµ„ç¹”é‡çµ„", D:"å¢è³¼è¨­å‚™"}, a: "D" },
        7: { t: "TKçš„ç²¾ç¾å ±å‘Šæ˜¯ä½¿ç”¨äº†ä¸‹åˆ—å“ªå€‹AIå¹³å°è¼”åŠ©è£½ä½œ?", o: {A:"Grok", B:"ChatGPT", C:"NotebookLM", D:"Perplexity"}, a: "D" },
        8: { t: "DPQMçš„é—œéµä»»å‹™-æ•¸ä½åŒ–è½‰å‹æ˜¯è‡ªå‹•åŒ–ç”¢å‡ºä¸‹åˆ—ä½•è€…å ±å‘Š?", o: {A:"æ¸¬è©¦å ±å‘Šèˆ‡MTBFå ±å‘Š", B:"DFEMA", C:"8Då ±å‘Š", D:"PFEMAå ±å‘Š"}, a: "A" },
        9: { t: "Which is not one of the Strategies Pillars of PRCM?", o: {A:"Enhance Sustaining", B:"Better Service for Customer", C:"Build up Engineering Knowledge", D:"Pneumonoultra...volcanoconiosis"}, a: "D" },
        10: { t: "Where the Knowledge Management of PRCM is?", o: {A:"GeDCC", B:"PDM", C:"PRCM Portal", D:"Moxa College"}, a: "C" },
        11: { t: "Which of the following is not Hard Skill of PRCM?", o: {A:"EMC&RF", B:"Safty&Hazloc", C:"Energy&Haz Substances", D:"Ontology&Epistemology"}, a: "D" },
        12: { t: "å“è³ªèˆ‡å¯é åº¦ç™½çš®æ›¸é è¨ˆç”šéº¼æ™‚å€™æ­£å¼ç™¼å¸ƒ?", o: {A:"2026Q4", B:"å·²ç¶“å®Œæˆæ­£å¼ç™¼ä½ˆ", C:"2027Q3", D:"2027Q2"}, a: "A" },
        13: { t: "ä½•è€…ä¸æ˜¯2025å¹´çš„å¯é åº¦å°ˆæ¡ˆ?", o: {A:"Nport 6150 Reliability", B:"Thin Gold Plated Contacts Effect", C:"PCB Supplier EISO enhancement", D:"Solder joint 20Y Reliability Test"}, a: "B" },
        14: { t: "ä½•è€…ä¸æ˜¯QRM 2026çš„æ¸¬è©¦èˆ‡é©—è­‰è¨ˆç•«?", o: {A:"Conformal Coating BGA æ‡‰åŠ›å½±éŸ¿", B:"è–„é‡‘éå±¤æ¥è§¸å½±éŸ¿", C:"å£“é›»ææ–™æ•£ç†±å¯é åº¦", D:"ç”¢å“PELï¼šé›»è§£é›»å®¹é©—è­‰"}, a: "B" },
        15: { t: "å“ªä½åŒä»é€£çºŒå¹¾å¹´åƒèˆ‡è¡¨æ¼”ï¼Œä»Šå¹´ä¹Ÿæœƒé–ƒäº®ç™»å°?", o: {A:"Jerry", B:"Lisa", C:"Boozer", D:"Dennis"}, a: "A" }
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const params = new URLSearchParams(window.location.search);
    const role = params.get('role') || 'player';
    const uid = localStorage.getItem('game_uid') || Math.random().toString(36).substring(7);
    localStorage.setItem('game_uid', uid);

    db.ref('resetTrigger').on('value', snap => {
        if (snap.val() === true) {
            if(role === 'player') localStorage.removeItem('boss_player_name');
            location.reload();
        }
    });

    function saveName() {
        const name = document.getElementById('player-name-input').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
        localStorage.setItem('boss_player_name', name);
        db.ref('players/' + uid).set(name);
        document.getElementById('name-overlay').classList.add('hidden');
        document.getElementById('player-view').classList.remove('hidden');
    }

    if(role === 'player') {
        if(!localStorage.getItem('boss_player_name')) document.getElementById('name-overlay').classList.remove('hidden');
        else {
            document.getElementById('player-view').classList.remove('hidden');
            db.ref('players/' + uid).set(localStorage.getItem('boss_player_name'));
        }
    } else if(role === 'display') {
        document.getElementById('display-view').classList.remove('hidden');
    } else if(role === 'admin') {
        document.getElementById('admin-view').classList.remove('hidden');
        const container = document.getElementById('admin-btns');
        for(let i=1; i<=15; i++) container.innerHTML += `<button onclick="changeQ(${i})" style="padding:15px; width:80px; background:#444; color:white; border-radius:10px; cursor:pointer;">${i}</button>`;
    }

    let hasSubmitted = false;
    let currentQNum = -1;
    let lastResId = "";

    db.ref('gameState').on('value', snap => {
        const state = snap.val() || { hp: BOSS_MAX_HP, status: 'waiting', q: 0 };
        
        // ã€ä¿®æ­£ã€‘æ–°ä»»å‹™ç™¼å¸ƒæ™‚ï¼Œé‡ç½®æ‰€æœ‰ Player ç‹€æ…‹
        if (state.q !== currentQNum) {
            hasSubmitted = false;
            currentQNum = state.q;
            if (role === 'player') {
                document.querySelectorAll('.q-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = "1";
                });
            }
        }

        const timerStr = state.timeLeft > 0 ? `â³ ${state.timeLeft}s` : "âŒ› æ™‚é–“åˆ°ï¼";

        if(role === 'display') {
            document.getElementById('d-timer').innerText = state.status === 'answering' ? timerStr : "";
            document.getElementById('hp-bar').style.width = (state.hp / BOSS_MAX_HP * 100) + "%";
            document.getElementById('hp-text').innerText = state.hp;
            
            // å¯¦æ™‚äººæ•¸é¡¯ç¤º
            Promise.all([db.ref('players').once('value'), db.ref('responses').once('value')]).then(results => {
                const total = results[0].numChildren();
                const answered = results[1].numChildren();
                if(state.status === 'answering') {
                    document.getElementById('vote-count').innerText = `å·²å›ç­”æˆ°å£«: ${answered} / ${total}`;
                } else {
                    document.getElementById('vote-count').innerText = `å·²é›†çµæˆ°å£«: ${total}`;
                }
            });

            if(state.status === 'answering') {
                const q = questionBank[state.q];
                document.getElementById('display-q-box').classList.remove('hidden');
                document.getElementById('d-title').innerText = q.t;
                document.getElementById('d-options').innerHTML = `<div>A: ${q.o.A}</div><div>B: ${q.o.B}</div><div>C: ${q.o.C}</div><div>D: ${q.o.D}</div>`;
                document.getElementById('round-num').innerText = "ä»»å‹™é€²è¡Œä¸­...";
                document.getElementById('boss-bubble').style.display = 'none';
            } 
            else if(state.status === 'result' && state.resId !== lastResId) {
                lastResId = state.resId;
                triggerAttackEffect(state);
            }
        }

        if(role === 'player') {
            if(state.status === 'answering' && !hasSubmitted) {
                const q = questionBank[state.q];
                document.getElementById('player-waiting').classList.add('hidden');
                document.getElementById('player-q-zone').classList.remove('hidden');
                document.getElementById('p-title').innerText = q.t;
                document.getElementById('pa').innerText = q.o.A; document.getElementById('pb').innerText = q.o.B;
                document.getElementById('pc').innerText = q.o.C; document.getElementById('pd').innerText = q.o.D;
                document.getElementById('p-q-timer').innerText = timerStr;
                
                if(state.timeLeft <= 0) {
                    document.querySelectorAll('.q-btn').forEach(btn => btn.disabled = true);
                }
            } else {
                document.getElementById('player-q-zone').classList.add('hidden');
                document.getElementById('player-waiting').classList.remove('hidden');
                document.getElementById('wait-status').innerText = hasSubmitted ? "ä»»å‹™å®Œæˆ" : "æº–å‚™ä¸­...";
                document.getElementById('wait-msg').innerText = hasSubmitted ? "æ”»æ“Šæº–å‚™ä¸­ï¼ğŸ’¥" : "ç­‰å¾…æŒ‡æ®å®˜ç™¼å¸ƒä»»å‹™...";
            }
        }
    });

    function triggerAttackEffect(state) {
        document.getElementById('display-q-box').classList.add('hidden');
        if(state.lastDmg > 0) {
            const dmgText = document.getElementById('dmg-text');
            dmgText.innerText = "-" + state.lastDmg;
            dmgText.classList.remove('dmg-float');
            void dmgText.offsetWidth;
            dmgText.classList.add('dmg-float');
            document.getElementById('display-view').classList.add('screen-shake', 'hurt-flash');
            document.getElementById('boss-img').classList.add('shake');
            setTimeout(() => {
                document.getElementById('display-view').classList.remove('screen-shake', 'hurt-flash');
                document.getElementById('boss-img').classList.remove('shake');
            }, 1000);
        }
        document.getElementById('msg-box').innerHTML = `
            <div style="font-size: 38px; font-weight: bold; margin-bottom: 20px;">
                <div style="color: #2ecc71;">ä»»å‹™æˆåŠŸç‡ï¼š${state.correctRate}%</div>
                <div style="font-size: 50px; color: #e74c3c;">ç¸½å‚·å®³ï¼š${state.lastDmg}</div>
            </div>`;
    }

    function changeQ(num) {
        db.ref('responses').remove();
        let timeLeft = 10;
        db.ref('gameState').update({ q: num, status: 'answering', lastDmg: 0, timeLeft: timeLeft, resId: "" });
        const timer = setInterval(() => {
            timeLeft--;
            if(timeLeft <= 0) { clearInterval(timer); db.ref('gameState/timeLeft').set(0); }
            else db.ref('gameState/timeLeft').set(timeLeft);
        }, 1000);
    }

    function submitAns(ans) {
        hasSubmitted = true;
        db.ref('gameState/timeLeft').once('value', snap => {
            db.ref('responses/' + uid).set({ 
                ans: ans, 
                name: localStorage.getItem('boss_player_name')
            });
        });
    }

    function calculateResult() {
        db.ref().once('value', snap => {
            const data = snap.val();
            const resps = data.responses || {};
            const qData = questionBank[data.gameState.q];
            const players = Object.values(resps);
            if(!players.length) return alert("æ²’äººå›ç­”ï¼");

            const correctCount = players.filter(p => qData.a.includes(p.ans)).length;
            const rate = correctCount / players.length; 
            const dmg = Math.floor(rate * BASE_DAMAGE); // åŸºç¤å‚·å®³ 1000

            db.ref('gameState').update({ 
                status: 'result', 
                hp: Math.max(0, data.gameState.hp - dmg), 
                lastDmg: dmg, 
                correctRate: Math.round(rate * 100), 
                resId: "res-" + Date.now()
            });
        });
    }

    function resetGame() {
        if(confirm("é‡ç½®æˆ°å ´ï¼Ÿæ­¤å‹•ä½œæœƒæ¸…ç©ºæ‰€æœ‰ç©å®¶åå­—ä¸¦åˆ·æ–°é é¢ã€‚")) {
            db.ref('/').set({
                gameState: { q:0, status:'waiting', hp: BOSS_MAX_HP, timeLeft: 10, resId: "", lastDmg: 0 },
                players: null, 
                responses: null, 
                resetTrigger: true
            }).then(() => {
                db.ref('resetTrigger').set(false);
                location.reload();
            });
        }
    }

    function toggleBGM() {
        const bgm = document.getElementById('game-bgm');
        if (bgm.paused) { bgm.play(); document.getElementById('bgm-control').innerText = "â¸ æš«åœ"; }
        else { bgm.pause(); document.getElementById('bgm-control').innerText = "â–¶ æ’­æ”¾"; }
    }
</script>
</body>
</html>
